<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Life Simulation Configurator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles from previous version... */
        body { font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .form-group { margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; background-color: #ffffff; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .form-group h3 { margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600; color: #111827; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
        label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #374151; }
        input[type=text], input[type=number], select { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        input:focus, select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .input-group { margin-bottom: 1rem; }
        .checkbox-label { display: flex; align-items: center; cursor: pointer; }
        input[type=checkbox] { height: 1rem; width: 1rem; border-radius: 0.25rem; border-color: #d1d5db; text-indigo-600 focus:ring-indigo-500; margin-right: 0.5rem; }
        /* Styling for status messages */
        #statusMessage { margin-top: 1rem; padding: 0.75rem 1rem; border-radius: 0.375rem; text-align: center; font-weight: 500; }
        .status-success { background-color: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .status-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .status-loading { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        /* Hide initially */
        #statusMessage:empty { display: none; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Financial Life Simulation Configurator</h1>

        <form id="simulationForm" class="space-y-6">
            <div class="form-group">
                <h3>General & Simulation Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="bucket_name">GCS Bucket Name (Required):</label>
                        <input type="text" id="bucket_name" name="bucket_name" required class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="file_name">Base Output File Name:</label>
                        <input type="text" id="file_name" name="file_name" value="sim_results" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="start_year">Start Year:</label>
                        <input type="number" id="start_year" name="start_year" value="2025" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="final_year">Final Year:</label>
                        <input type="number" id="final_year" name="final_year" value="2074" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="retirement_year">Retirement Year:</label>
                        <input type="number" id="retirement_year" name="retirement_year" value="2055" class="mt-1">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <h3>Initial Capital (£)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="input-group">
                        <label for="starting_cash">Starting Cash:</label>
                        <input type="number" step="any" id="starting_cash" name="starting_cash" value="5000" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="fixed_interest_capital">Fixed Interest Capital:</label>
                        <input type="number" step="any" id="fixed_interest_capital" name="fixed_interest_capital" value="1000" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="NSI_capital">NSI Capital:</label>
                        <input type="number" step="any" id="NSI_capital" name="NSI_capital" value="50000" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="pension_capital">Pension Capital:</label>
                        <input type="number" step="any" id="pension_capital" name="pension_capital" value="150000" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="ISA_capital">ISA Capital:</label>
                        <input type="number" step="any" id="ISA_capital" name="ISA_capital" value="150000" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="GIA_capital">GIA Capital:</label>
                        <input type="number" step="any" id="GIA_capital" name="GIA_capital" value="500000" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="GIA_initial_units">GIA Initial Units:</label>
                        <input type="number" step="any" id="GIA_initial_units" name="GIA_initial_units" value="100.0" class="mt-1">
                    </div>
                     <div class="input-group">
                        <label for="GIA_initial_average_buy_price">GIA Avg. Buy Price (Optional):</label>
                        <input type="number" step="any" id="GIA_initial_average_buy_price" name="GIA_initial_average_buy_price" placeholder="Leave blank to auto-calculate" class="mt-1">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <h3>Annual Rates & Growth (%)</h3>
                 <p class="text-xs text-gray-500 mb-4">Enter rates as decimals (e.g., 0.02 for 2%)</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="input-group">
                        <label for="fixed_interest_rate">Fixed Interest Rate:</label>
                        <input type="number" step="any" id="fixed_interest_rate" name="fixed_interest_rate" value="0.02" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="NSI_interest_rate">NSI Interest Rate:</label>
                        <input type="number" step="any" id="NSI_interest_rate" name="NSI_interest_rate" value="0.02" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="pension_growth_rate">Pension Growth Rate:</label>
                        <input type="number" step="any" id="pension_growth_rate" name="pension_growth_rate" value="0.02" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="ISA_growth_rate">ISA Growth Rate:</label>
                        <input type="number" step="any" id="ISA_growth_rate" name="ISA_growth_rate" value="0.02" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="GIA_growth_rate">GIA Growth Rate:</label>
                        <input type="number" step="any" id="GIA_growth_rate" name="GIA_growth_rate" value="0.02" class="mt-1">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <h3>Employment & Pension Contributions (%)</h3>
                 <p class="text-xs text-gray-500 mb-4">Enter percentages as decimals (e.g., 0.07 for 7%)</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="employee_pension_contributions_pct">Employee Pension Contrib %:</label>
                        <input type="number" step="any" id="employee_pension_contributions_pct" name="employee_pension_contributions_pct" value="0.07" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="employer_pension_contributions_pct">Employer Pension Contrib %:</label>
                        <input type="number" step="any" id="employer_pension_contributions_pct" name="employer_pension_contributions_pct" value="0.07" class="mt-1">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <h3>Living Costs & Salary</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div class="input-group">
                        <label for="base_living_cost">Base Living Cost (£, Start Year):</label>
                        <input type="number" step="any" id="base_living_cost" name="base_living_cost" value="20000" class="mt-1">
                    </div>
                     <div class="input-group">
                        <label for="base_salary">Base Salary (£, Year Before Start):</label>
                        <input type="number" step="any" id="base_salary" name="base_salary" value="100000" class="mt-1">
                    </div>
                     <div class="input-group">
                        <label for="living_costs_rate_pre_retirement">Living Costs Growth Rate (Pre-Retirement %):</label>
                        <input type="number" step="any" id="living_costs_rate_pre_retirement" name="living_costs_rate_pre_retirement" value="0.02" class="mt-1">
                         <p class="text-xs text-gray-500 mt-1">Enter rate as decimal (e.g., 0.02 for 2%)</p>
                    </div>
                     <div class="input-group">
                        <label for="living_costs_rate_post_retirement">Living Costs Growth Rate (Post-Retirement %):</label>
                        <input type="number" step="any" id="living_costs_rate_post_retirement" name="living_costs_rate_post_retirement" value="0.04" class="mt-1">
                         <p class="text-xs text-gray-500 mt-1">Enter rate as decimal (e.g., 0.04 for 4%)</p>
                    </div>
                     <div class="input-group">
                        <label for="salary_growth_rate">Salary Growth Rate (%):</label>
                        <input type="number" step="any" id="salary_growth_rate" name="salary_growth_rate" value="0.01" class="mt-1">
                         <p class="text-xs text-gray-500 mt-1">Enter rate as decimal (e.g., 0.01 for 1%)</p>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <h3>Strategy</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="buffer_multiplier">Cash Buffer Multiplier:</label>
                        <input type="number" step="any" id="buffer_multiplier" name="buffer_multiplier" value="1.2" class="mt-1">
                        <p class="text-xs text-gray-500 mt-1">Multiplier for cash buffer based on current year's living costs.</p>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <h3>Utility Function Parameters</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="input-group">
                        <label for="utility_baseline">Utility Baseline (£):</label>
                        <input type="number" step="any" id="utility_baseline" name="utility_baseline" value="30000" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="utility_linear_rate">Utility Linear Rate (£/yr):</label>
                        <input type="number" step="any" id="utility_linear_rate" name="utility_linear_rate" value="0" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="utility_exp_rate">Utility Exp. Rate (%):</label>
                        <input type="number" step="any" id="utility_exp_rate" name="utility_exp_rate" value="0.005" class="mt-1">
                         <p class="text-xs text-gray-500 mt-1">Enter rate as decimal (e.g., 0.005 for 0.5%)</p>
                    </div>
                    <div class="input-group">
                        <label for="non_linear_utility">Non-Linear Utility Exponent:</label>
                        <input type="number" step="any" id="non_linear_utility" name="non_linear_utility" value="0.99" class="mt-1">
                    </div>
                    <div class="input-group">
                        <label for="utility_discount_rate">Utility Discount Rate (%):</label>
                        <input type="number" step="any" id="utility_discount_rate" name="utility_discount_rate" value="0.001" class="mt-1">
                         <p class="text-xs text-gray-500 mt-1">Enter rate as decimal (e.g., 0.001 for 0.1%)</p>
                    </div>
                    <div class="input-group">
                        <label for="volatility_penalty">Volatility Penalty Factor:</label>
                        <input type="number" step="any" id="volatility_penalty" name="volatility_penalty" value="100000" class="mt-1">
                    </div>
                </div>
            </div>

             <div class="form-group">
                <h3>Troubleshooting</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="log_level">Logging Level:</label>
                        <select id="log_level" name="log_level" class="mt-1">
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO" selected>INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                    </div>
                    <div class="input-group">
                         <label for="save_debug_data" class="checkbox-label">
                            <input type="checkbox" id="save_debug_data" name="save_debug_data" class="form-checkbox">
                            <span>Save Debug Data</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="text-center mt-8">
                <button type="button" id="runButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 ease-in-out shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Run Simulation
                </button>
            </div>
        </form>

        <div id="statusMessage"></div>

        <div class="mt-8 p-4 bg-gray-800 text-white rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-2 text-gray-300">Generated Command (for reference):</h3>
            <pre id="outputCommand" class="text-sm whitespace-pre-wrap break-words"></pre>
        </div>

    </div>

    <script>
        // Get references
        const runButton = document.getElementById('runButton');
        const form = document.getElementById('simulationForm');
        const outputCommand = document.getElementById('outputCommand'); // Reference for command display
        const statusMessage = document.getElementById('statusMessage'); // Reference for status display

        // Add event listener to the button
        runButton.addEventListener('click', async () => {
            // Disable button and show loading state
            runButton.disabled = true;
            statusMessage.textContent = 'Starting simulation...';
            statusMessage.className = 'status-loading'; // Apply loading style

            // 1. Collect form data into an object
            const formData = new FormData(form);
            const params = {};
            let commandPreview = 'python simulate_main.py'; // For display only

            formData.forEach((value, key) => {
                const element = form.elements[key];

                // Handle checkbox separately
                if (element.type === 'checkbox') {
                    params[key] = element.checked;
                    if (element.checked) {
                        commandPreview += ` --${key}`;
                    }
                }
                // Convert numbers from strings if necessary
                else if (element.type === 'number' && value !== '') {
                    params[key] = parseFloat(value); // Or parseInt if integer expected
                    commandPreview += ` --${key}=${value}`;
                }
                // Handle non-empty text/select or required fields
                else if (value !== '' || element.required) {
                     // Skip optional GIA price if blank
                    if (key === 'GIA_initial_average_buy_price' && value === '') {
                       params[key] = null; // Send null or omit entirely
                    } else {
                        params[key] = value;
                        commandPreview += ` --${key}=${value}`;
                    }
                } else {
                     params[key] = null; // Send null for empty optional fields
                }
            });

             // Display the command preview
             outputCommand.textContent = commandPreview;
             console.log("Parameters being sent:", params);

            // 2. Send data to the backend API
            try {
                const response = await fetch('/run_simulation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params), // Send parameters as JSON
                });

                const result = await response.json(); // Parse JSON response from backend

                if (response.ok) {
                    console.log('Simulation started successfully:', result);
                    statusMessage.textContent = result.message || 'Simulation started successfully!';
                    statusMessage.className = 'status-success';
                } else {
                    console.error('Error starting simulation:', result);
                    statusMessage.textContent = `Error: ${result.message || 'Failed to start simulation.'}`;
                    statusMessage.className = 'status-error';
                }

            } catch (error) {
                console.error('Network or fetch error:', error);
                statusMessage.textContent = `Network error: ${error.message}`;
                statusMessage.className = 'status-error';
            } finally {
                // Re-enable button after request completes (success or error)
                runButton.disabled = false;
            }
        });
    </script>

</body>
</html>
